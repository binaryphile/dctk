#!/usr/bin/env bash

[[ -n $_dctk ]] && return
readonly _dctk=loaded

source kzn.bash
initialize_kzn

dctk_exports() {
  local source_path

  _DCTK_PROG=$(basename "$BASH_SOURCE")
  export _DCTK_PROG

  source_path=$(realpath "$BASH_SOURCE")
  source_path=$(dirname "$source_path")
  printf -v _"${_DCTK_PROG^^}"_ROOT '%s' "$(absolute_path "$source_path"/../..)/$_DCTK_PROG"
  eval "$(printf 'export _%s_ROOT' "${_DCTK_PROG^^}")"
}

dctk_main() {
  local command=${1:-}; shift ||:
  local -a args=( "$@" )
  local no_such_command
  printf -v no_such_command '%s: no such command "%s"\n' "$_DCTK_PROG" "$command"

  # shellcheck disable=SC2016
  eval "$(printf 'local libexec=$_%s_ROOT/libexec' "${_DCTK_PROG^^}")"

  route command libexec args no_such_command
}

route() {
  local params=( command libexec @args no_such_command )
  eval "$(passed params "$@")"

  local -a roots=( "$libexec" )
  local command_path

  case $command in
    ''| '-h' | '--help' )
      exec "$libexec"/help
      ;;
    * )
      # shellcheck disable=SC2059,SC2154
      command_path=$(find_command command roots) || errexit "$no_such_command"
      shift
      # shellcheck disable=SC2086
      exec "$command_path" "${args[@]:-}"
      ;;
  esac
}

find_command() {
  # shellcheck disable=SC2034
  local params=( command @roots )
  eval "$(passed params "$@")"

  local libexec=${roots[0]}
  local command_path=$libexec/$command

  is_executable_file "$command_path" || return
  puts "$command_path"
}

return 0 2>/dev/null ||:

strict_mode on
dctk_exports
dctk_main "$@"
