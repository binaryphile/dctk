#!/usr/bin/env bash

source kaizen.bash
export DCTK_PROG=$(basename -- "$0")

absolute_dirname "$BASH_SOURCE"
project_root=$__/../..
libexec=$project_root/dctk/libexec

echo='printf -- %s\n'

main () {
  local command=${1:-}; shift ||:

  case $command in
    ''|help ) exec "$libexec"/help;;
  esac
  find_command "$command" "$@" || die "$__errmsg"
  exec "$__" "$@"
}

find_command() {
  local command=$1; shift

  search_roots "$command" "$libexec" && return
  (( $# )) && structured_search "$command" "$project_root/$DCTK_PROG" || $(raise CommandNotFoundError "no such command '$command'")
}

structured? () {
  directory? "$1"/bin || directory? "$1"/libexec
}

search_roots () {
  local command=$1; shift
  local root

  for root in "$@"; do
    executable_file? "$root/$command" || continue
    __=$root/$command
    return
  done
  return 1
}

structured_search () {
  local command=$1
  local root=$2

  structured? "$root"
  case $? in
    0 ) search_roots "$command" "$root"/bin "$root"/libexec ;;
    * ) search_roots "$command" "$root"                     ;;
  esac
}

sourced? && return
strict_mode on

main "$@" || die
