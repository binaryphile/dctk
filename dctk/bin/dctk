#!/usr/bin/env bash

source kaizen.bash all=1

$($module dctk)

$trim_to_last / "$BASH_SOURCE"
export DCTK_PROG=$__

main () {
  $($grabkw help_flag from "$1"); shift
  local command=$1              ; shift
  $($bring root)

  (( help_flag )) && exec "$root"/libexec/help
  find_command "$command"
  exec "$__" "$@"
}

find_command() {
  local command=$1; shift
  local libexec=$1; shift

  search_roots "$command" "$libexec" && return
  (( $# )) && structured_search "$command" "$@" || $($raise CommandNotFoundError errmsg="no such command '$command'")
}

structured? () {
  $directory? "$1"/bin || $directory? "$1"/libexec
}

search_roots() {
  local command=$1; shift
  local root

  for root in "$@"; do
    $executable_file? "$root/$command" || continue
    __=$root/$command
    return
  done
  return 1
}

structured_search() {
  local command=$1
  local root=$2

  structured? "$root"
  case $? in
    0 ) search_roots "$command" "$root"/bin "$root"/libexec ;;
    * ) search_roots "$command" "$root"                     ;;
  esac
}

$sourced? && return
$strict_mode on

$get <<'EOS'
  ''   --help   ''   "ask for help"
EOS
$($parse_options "$__" "$@")  || $die "$usage"
main "$__" "$@"               || $die "$usage"
